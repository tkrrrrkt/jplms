# 時系列メモ（Development Chronological Notes）

開発中に遭遇した重要な判断・問題・学びを時系列で記録するファイル。

---

## 2026-02-11: プロジェクト初期セットアップ

### 完了した作業
- Git/GitHub リポジトリ初期化（`main` ブランチ）
- `.kiro/steering/` 配下にプロジェクト憲法ファイル群を作成
  - `tech.md`, `product.md`, `database.md`, `security.md`, `structure.md`, `development-process.md`
- `.kiro/specs/仕様書/` 配下に仕様概要・機能一覧を作成
- `local/timetrack` プラグインスケルトン作成（version.php, access.php, services.php, settings.php, lib.php, lang/）
- `theme/lambda_child` テーマスケルトン作成
- Docker 開発環境構築（4コンテナ構成）
- CLAUDE.md 作成

### Docker 環境に関する重要な判断

| 項目 | 当初の計画 | 変更後 | 理由 |
|------|-----------|--------|------|
| Moodle イメージ | `bitnami/moodle:4.5` | `moodlehq/moodle-php-apache:8.2` | bitnami イメージが Docker Hub に存在しない（廃止/未公開） |
| ポート | 8080 | 8880 | ホスト上で Keycloak（別プロジェクト）が 8080 を使用中 |
| Moodle ソース | イメージに内蔵 | Git clone + bind-mount | moodlehq イメージはPHP+Apacheのみ提供 |

### 遭遇した問題と解決策

#### 1. Windows Git Bash のパス変換問題
- **症状**: `docker compose exec` 経由で `/var/www/html/...` を指定すると、Git Bash が `C:/Program Files/Git/var/www/html/...` に変換してしまう
- **解決策**: `docker exec <container> bash -c "php /var/www/html/..."` を使用する（`docker compose exec` を避ける）

#### 2. config.php のパーミッション問題
- **症状**: Moodle インストール後、ブラウザアクセスで config.php が読めない
- **原因**: install.php が config.php を `root:root 640` で作成する
- **解決策**: `chmod 644 /var/www/html/config.php && chown www-data:www-data /var/www/html/config.php`

#### 3. dataroot のダブルスラッシュ問題
- **症状**: config.php 内のパスが `//var/www/moodledata` になる
- **原因**: Windows Git Bash のパスエスケープ
- **解決策**: sed で修正、またはセットアップスクリプト使用時は `docker exec` + `bash -c` で回避

#### 4. install.xml の空 TABLES セクション問題（最重要）
- **症状**: Moodle インストールが "Missing TABLES section" エラーで失敗
- **原因**: `local/timetrack/db/install.xml` に `<TABLES>` タグはあるが `<TABLE>` 子要素がない（コメントのみ）→ XMLDB パーサーが拒否
- **解決策**: install.xml を削除（spec-design フェーズで実際のテーブル定義と共に再作成する）
- **教訓**: **Moodle プラグインで install.xml を作成する場合、空の TABLES セクションは絶対に作らない。テーブル定義が確定するまで install.xml 自体を作成しない。**

#### 5. upgraderunning ロック問題
- **症状**: インストールが途中で失敗した後、再インストールできない
- **原因**: `mdl_config` テーブルの `upgraderunning` フラグが残る
- **解決策**: `DELETE FROM mdl_config WHERE name = 'upgraderunning'`

#### 6. admin パスワード設定失敗
- **症状**: インストール完了後、`admin / Admin1234!` でログインできない
- **原因**: CLI インストール時にシェルが `!` を履歴展開として解釈した可能性
- **解決策**: `php /var/www/html/admin/cli/reset_password.php --username=admin --password='Admin1234!'`

### Moodle インストールの所要時間
- 初回インストール（CLI）: 約15〜25分
- 約200個のプラグインを順次インストールするため長時間かかるのは正常
- バックグラウンドで実行し、完了を待つのが推奨

### 最終的な動作確認
- Moodle 4.5.10 が `http://localhost:8880` で稼働
- admin ログイン成功
- `local_timetrack` プラグイン登録済み（version 2026021100）
- `theme_lambda_child` テーマ登録済み
- Git コミット: `9675362 fix: Switch to moodlehq Docker image and fix Moodle install issues`

---

## テンプレート（今後の記録用）

<!--
## YYYY-MM-DD: タイトル

### 完了した作業
- ...

### 重要な判断
- ...

### 遭遇した問題と解決策
- ...

### 次のステップ
- ...
-->
