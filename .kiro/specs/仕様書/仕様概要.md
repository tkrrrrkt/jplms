# 仕様概要

**Project:** Japan LMS MVP — 日本語教師育成プラットフォーム
**Client:** 日本イングレサ株式会社（代表取締役: 劉 志友）
**Version:** 1.1.0
**Last Updated:** 2026-02-11

---

## 1. システム概要

在日中国人を主要ターゲットとし、日本語教師資格取得に必要な「420時間学習」をオンラインで完結できるLMS。中国での英語教師育成LMS（TESOL China: tesolchina.cn）の成功モデルをベースに、日本の資格制度に適合させたMVPを構築する。

### 技術基盤

| 項目 | 技術 |
|------|------|
| LMS Engine | Moodle 4.x (Latest Stable) |
| Language | PHP 8.2 推奨（8.1〜8.3対応、型宣言必須） |
| Server | Ubuntu 22.04 LTS / Nginx + PHP-FPM / MySQL 8.0 |
| Cache | Redis 7.x（セッション + MUCキャッシュ、インスタンス分離） |
| Theme | Lambda (Premium) + Child Theme (`theme_lambda_child`) |
| Video | Vimeo (ドメイン制限付き) |
| Payment | MVP: paygw_stripe + enrol_fee / Phase 2: Custom Webhook |
| Architecture | Single-tenant / Plugin-First |
| Custom Plugin | `local_timetrack`（420時間計測・不正防止・進捗管理） |

### 予算・スコープ

- **予算:** 120〜150万円（サーバー・テーマ費含む）
- **方針:** 最小構成で立ち上げ → 運用状況に応じて段階投資・拡張

## 2. 学習フロー（中国版TESOLモデル準拠）

```
[1. 決済・登録] Stripe決済 → Moodleコース自動登録
       ↓
[2. 順次学習] Unit 1〜N（教材＋動画＋単元テスト 70%合格で次Unit解放）
       ↓                    ※ 常時420時間の累計計測（Heartbeat 30秒間隔）
[3. 課題提出] 教案(doc) + 試講動画(mp4) アップロード
       ↓
[4. 講師添削] 10項目ルーブリックで採点（60点満点）
       ↓
[5. 最終試験] オンライン試験（40点満点）
       ↓
[6. 成績判定] 課題(60) + 試験(40) = 合計100点、60点以上で合格
       ↓                    ※ 各項目が満点の60%以上必要
[7. 修了証発行] PDF自動生成・ダウンロード
```

## 3. ユーザーロール

| ロール | 概要 |
|--------|------|
| 受講者 | 動画視聴 → テスト → 課題提出 → 修了証取得 |
| 講師 | 提出課題のオンライン添削・採点、学習進捗確認 |
| 管理者 | 学習時間ログ監査、コース・受講者管理、売上管理 |

## 4. MVP機能サマリ

1. 会員登録・コース購入（paygw_stripe + enrol_fee → 即時受講）
2. 動画学習・資料閲覧（順次学習、70%合格基準）
3. 小テスト・課題提出（教案 + 試講動画 + 講師添削）
4. 学習進捗管理（420時間計測・13層不正防止・累計表示）
5. 成績管理（課題60 + 試験40 = 100、合格60点以上）
6. 修了証発行（PDF自動発行）
7. 法的準拠（特定商取引法表記ページ）

→ 各機能の詳細は [機能一覧.md](機能一覧.md) を参照

## 5. 主要技術決定

| 決定事項 | 選択 | 理由 |
|---------|------|------|
| LMSエンジン | Moodle 4.x | 教育機能の9割をカバー、開発コスト大幅削減 |
| カスタムプラグイン名 | `local_timetrack` | 簡潔なFrankenstyle名、4テーブル設計に整合 |
| Stripe決済方式 | 段階的アプローチ | MVP: paygw_stripe(コード不要) → Phase 2: Custom Webhook |
| テーマ | Lambda Premium + 子テーマ | 成熟したレスポンシブテーマ、子テーマで安全カスタマイズ |
| 動画配信 | Vimeo（セルフホスト不採用） | ドメイン制限でコピー防止、CDNでパフォーマンス確保 |
| 学習計測方式 | Heartbeat + 3段階パイプライン | 30秒間隔→raw INSERT→Cron集計→日次/累計サマリ |
| 不正防止アーキテクチャ | 13層多層防御 | Page Visibility + BroadcastChannel + Vimeo SDK等 |
| キャッシュ | Redis必須（2インスタンス） | セッション高速化 + MUCキャッシュ、evictionポリシー分離 |
| DBテーブル設計 | 4テーブル構成 | heartbeat(raw)/daily(集計)/total(累計)/video(セグメント) |
| PHP版 | 8.2推奨 | OPcacheデフォルト値がMoodle推奨に合致 |

## 6. データパイプライン概要

```
[Browser Heartbeat 30秒間隔]
    ↓ INSERT only（UPDATEなし、ロック競合回避）
[mdl_local_timetrack_heartbeat]（rawテーブル、高速INSERT専用）
    ↓ Cron: 5分間隔で aggregate_time タスク
[mdl_local_timetrack_daily]（日次サマリー、UPSERT）
[mdl_local_timetrack_total]（累積合計、ダッシュボード用）
    ↓ Cron: 毎日3:30 AM で cleanup_heartbeats タスク
[30日経過した処理済みHeartbeatを削除]
```

→ 詳細は steering [database.md](../../.kiro/steering/database.md) を参照

## 7. Phase 2以降の拡張予定

- Custom Webhook決済（事前登録不要UX）
- 就職支援掲示板
- 登録日本語教員API連携
- オフライン試験対応
- 証書オンライン検証
- AI自動添削補助
- インボイス制度対応

---

## 更新履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2026-02-11 | 1.1.0 | 技術決定セクション追加、データパイプライン追加、プラグイン名local_timetrack統一、Stripe段階的アプローチ反映、PHP 8.2/Redis追記 |
| 2026-02-11 | 1.0.0 | 初版作成（TESOL中国版モデル・メール情報をベースに整理） |
